<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go#Chenk Laundry Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0d6efd; --bg: #f4f7fe; }
        body { background-color: var(--bg); font-family: 'Inter', sans-serif; }
        .card { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.02); }
        .nav-pills .nav-link { border-radius: 12px; padding: 12px; font-weight: 600; color: #6c757d; }
        .nav-pills .nav-link.active { background-color: var(--primary); box-shadow: 0 4px 15px rgba(13,110,253,0.3); }
        #area-nota { background: white; border: 1px solid #eee; border-radius: 15px; padding: 20px; font-family: monospace; }
        @media print { body * { visibility: hidden; } #area-nota, #area-nota * { visibility: visible; } #area-nota { position: absolute; left: 0; top: 0; width: 100%; border: none; } }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary py-3 mb-4 no-print">
    <div class="container"><span class="navbar-brand fw-bold"><i class="bi bi-water me-2"></i>GO#CHENK LAUNDRY</span></div>
</nav>

<div class="container no-print">
    <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded-4 shadow-sm" id="pills-tab">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-order" type="button">Transaksi</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-riwayat" type="button" onclick="loadRiwayat()">Riwayat</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-keuangan" type="button" onclick="loadKeuangan()">Keuangan</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-order">
            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="card p-4 shadow-sm">
                        <form id="f-order" oninput="hitung()">
                            <h5 class="fw-bold mb-4">Order Baru</h5>
                            <input type="text" id="nama" class="form-control mb-3" placeholder="Nama Pelanggan">
                            <div class="row g-2 mb-3">
                                <div class="col-6"><select id="jenis" class="form-select" onchange="toggleLayanan()"><option value="Kiloan">Kiloan</option><option value="Satuan">Satuan</option></select></div>
                                <div id="box-durasi" class="col-6"><select id="durasi" class="form-select"><option value="1">1 Hari</option><option value="2">2 Hari</option><option value="3">3 Hari</option><option id="opt-4hari" value="4">4 Hari</option></select></div>
                            </div>
                            <div id="area-kiloan">
                                <div class="row g-2 mb-3">
                                    <div class="col-8"><select id="jasa" class="form-select" onchange="cekDurasi(); hitung();"><option value="Cuci Setrika">Cuci Setrika</option><option value="Cuci Lipat">Cuci Lipat</option><option value="Setrika Saja">Setrika Saja</option></select></div>
                                    <div class="col-4"><input type="number" id="berat" class="form-control" value="2"></div>
                                </div>
                            </div>
                            <div id="area-satuan" style="display:none"><input type="text" id="item" class="form-control mb-2" placeholder="Nama Barang"><input type="number" id="hargaS" class="form-control mb-3" placeholder="Total Harga"></div>
                            <input type="number" id="dp" class="form-control mb-4" placeholder="DP (Rp)">
                            <button type="button" onclick="simpan()" id="btn-simpan" class="btn btn-primary w-100 fw-bold py-2">SIMPAN TRANSAKSI</button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div id="area-nota" class="shadow-sm">
                        <div class="text-center"><h5 class="fw-bold m-0">GO#CHENK LAUNDRY</h5><small>Nota Digital</small></div>
                        <hr style="border-top: 1px dashed #000">
                        <div class="small">
                            <div class="d-flex justify-content-between"><span>Nama:</span><b id="n-nama">-</b></div>
                            <div class="d-flex justify-content-between"><span>Layanan:</span><span id="n-lay">-</span></div>
                            <div class="d-flex justify-content-between"><span>Detail:</span><span id="n-det">-</span></div>
                            <hr style="border-top: 1px dashed #000">
                            <div class="d-flex justify-content-between fw-bold"><span>TOTAL:</span><span>Rp <span id="n-tot">0</span></span></div>
                            <div class="d-flex justify-content-between"><span>DP:</span><span>Rp <span id="n-dp">0</span></span></div>
                            <div class="d-flex justify-content-between text-danger fw-bold"><span>SISA:</span><span>Rp <span id="n-sis">0</span></span></div>
                        </div>
                        <button class="btn btn-dark btn-sm w-100 mt-4 no-print" onclick="window.print()"><i class="bi bi-printer me-2"></i>CETAK NOTA</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-riwayat">
            <div class="card p-4 shadow-sm">
                <div class="d-flex justify-content-between mb-3">
                    <input type="text" id="cariR" class="form-control w-50" placeholder="Cari nama..." onkeyup="filterTabel()">
                    <button class="btn btn-danger btn-sm" onclick="hapusTerpilih()"><i class="bi bi-trash"></i> Hapus Terpilih</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="tableR">
                        <thead class="table-light">
                            <tr>
                                <th><input type="checkbox" onclick="toggleAll(this)"></th>
                                <th onclick="sortTable(1)" style="cursor:pointer">ID</th>
                                <th onclick="sortTable(2)" style="cursor:pointer">Pelanggan</th>
                                <th>Total</th>
                                <th>Bayar</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-keuangan">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0">Manajemen Kas</h5>
                <button class="btn btn-outline-danger btn-sm" onclick="resetKeuangan()"><i class="bi bi-trash3"></i> Reset Data Pengetesan</button>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-4"><div class="card p-3 shadow-sm border-start border-primary border-4"><small>Masuk</small><h4 id="stat-m" class="text-primary fw-bold">0</h4></div></div>
                <div class="col-md-4"><div class="card p-3 shadow-sm border-start border-danger border-4"><small>Keluar</small><h4 id="stat-k" class="text-danger fw-bold">0</h4></div></div>
                <div class="col-md-4"><div class="card p-3 shadow-sm border-start border-success border-4"><small>Saldo</small><h4 id="stat-s" class="text-success fw-bold">0</h4></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card p-4 shadow-sm">
                        <h6 class="fw-bold mb-3">Input Kas Manual</h6>
                        <input type="text" id="k-ket" class="form-control mb-2" placeholder="Keterangan">
                        <input type="number" id="k-mas" class="form-control mb-2" placeholder="Pemasukan (Rp)">
                        <input type="number" id="k-kel" class="form-control mb-3" placeholder="Pengeluaran (Rp)">
                        <button onclick="simpanKeu()" class="btn btn-success w-100 fw-bold">SIMPAN KAS</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card p-4 h-100 shadow-sm text-center">
                        <h6 class="fw-bold mb-3">Grafik Saldo Harian</h6>
                        <div style="height: 220px;"><canvas id="chartHarian"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwx-koII4ULilz02Y0r0VT7gfVw5abpQcaV4xPEux55zzeCSgRq16H2f_BjUSXTwut1/exec"; // GANTI DENGAN URL APPS SCRIPT ANDA

    function toggleLayanan() {
        const j = document.getElementById('jenis').value;
        document.getElementById('area-kiloan').style.display = j==='Kiloan'?'block':'none';
        document.getElementById('box-durasi').style.display = j==='Kiloan'?'block':'none';
        document.getElementById('area-satuan').style.display = j==='Satuan'?'block':'none';
        cekDurasi(); hitung();
    }

    function cekDurasi() {
        const jasa = document.getElementById('jasa').value;
        const opt4 = document.getElementById('opt-4hari');
        if (jasa !== "Cuci Setrika") { 
            opt4.disabled = true; 
            if (document.getElementById('durasi').value === "4") document.getElementById('durasi').value = "3";
        } else { opt4.disabled = false; }
    }

    function hitung() {
        const j = document.getElementById('jenis').value;
        let t = 0, lay = "", det = "";
        if(j === 'Kiloan') {
            const jasa = document.getElementById('jasa').value, dur = parseInt(document.getElementById('durasi').value), b = parseFloat(document.getElementById('berat').value || 0);
            let h = (jasa === 'Cuci Setrika') ? [0, 10000, 7000, 6000, 5000][dur] : [0, 7000, 5000, 4000, 4000][dur];
            t = h * b; lay = jasa + " (" + dur + "hr)"; det = b + "kg @Rp" + h.toLocaleString();
        } else {
            t = parseInt(document.getElementById('hargaS').value || 0); lay = "Satuan: " + (document.getElementById('item').value || "-"); det = "Manual";
        }
        const dp = parseInt(document.getElementById('dp').value || 0);
        document.getElementById('n-nama').innerText = document.getElementById('nama').value || "-";
        document.getElementById('n-lay').innerText = lay; document.getElementById('n-det').innerText = det;
        document.getElementById('n-tot').innerText = t.toLocaleString();
        document.getElementById('n-dp').innerText = dp.toLocaleString();
        document.getElementById('n-sis').innerText = (t - dp).toLocaleString();
        return {t, lay};
    }

    async function simpan() {
        const b = document.getElementById('btn-simpan'); b.disabled = true; b.innerText = "Proses...";
        const n = hitung();
        const data = {nama:document.getElementById('nama').value, jenis:document.getElementById('jenis').value, layanan:n.lay, durasi:document.getElementById('durasi').value, berat:document.getElementById('berat').value, total:n.t, dp:document.getElementById('dp').value||0};
        await fetch(SCRIPT_URL + "?action=insert", { method: "POST", body: JSON.stringify(data) });
        alert("Transaksi Tersimpan!"); document.getElementById('f-order').reset(); hitung(); b.disabled = false; b.innerText = "SIMPAN TRANSAKSI";
    }

    async function loadRiwayat() {
        const res = await fetch(SCRIPT_URL + "?action=read");
        const data = await res.json();
        const tb = document.querySelector('#tableR tbody');
        tb.innerHTML = data.map(r => `
            <tr>
                <td><input type="checkbox" class="row-check" value="${r[0]}"></td>
                <td><small>${r[0]}</small></td>
                <td><b>${r[2]}</b></td>
                <td>Rp ${parseInt(r[7]).toLocaleString()}</td>
                <td>${r[9]==='Lunas' ? '<span class="badge bg-success">Lunas</span>' : `<button class="btn btn-xs btn-warning py-0" onclick="updateStatus('${r[0]}','bayar','Lunas')">Lunas</button>`}</td>
                <td>${r[10]==='Done' ? '<span class="badge bg-primary">Selesai</span>' : `<button class="btn btn-xs btn-outline-info py-0" onclick="updateStatus('${r[0]}','laundry','Done')">Proses</button>`}</td>
                <td><button class="btn btn-link text-danger p-0" onclick="hapusItem('${r[0]}')"><i class="bi bi-trash"></i></button></td>
            </tr>
        `).join('');
    }

    async function updateStatus(id, type, val) {
        if(!confirm("Ubah status?")) return;
        await fetch(SCRIPT_URL + "?action=updateStatus", { method: "POST", body: JSON.stringify({id, type, val}) });
        loadRiwayat(); loadKeuangan();
    }

    async function resetKeuangan() {
        if(!confirm("Hapus semua catatan kas? (Data riwayat tetap aman)")) return;
        await fetch(SCRIPT_URL + "?action=resetKeuangan", { method: "POST", body: JSON.stringify({}) });
        loadKeuangan();
    }

    function filterTabel() {
        let val = document.getElementById("cariR").value.toUpperCase();
        let rows = document.querySelector("#tableR tbody").rows;
        for (let row of rows) { row.style.display = row.cells[2].innerText.toUpperCase().includes(val) ? "" : "none"; }
    }

    function sortTable(n) {
        let table = document.getElementById("tableR"), switching = true, dir = "asc", count = 0;
        while (switching) {
            switching = false; let rows = table.rows;
            for (var i = 1; i < (rows.length - 1); i++) {
                var s = false; var x = rows[i].cells[n], y = rows[i+1].cells[n];
                if (dir == "asc" ? x.innerText.toLowerCase() > y.innerText.toLowerCase() : x.innerText.toLowerCase() < y.innerText.toLowerCase()) { s = true; break; }
            }
            if (s) { rows[i].parentNode.insertBefore(rows[i+1], rows[i]); switching = true; count++; }
            else if (count == 0 && dir == "asc") { dir = "desc"; switching = true; }
        }
    }

    async function hapusItem(id) {
        if(confirm("Hapus data ini?")) {
            await fetch(SCRIPT_URL + "?action=deleteRow", { method: "POST", body: JSON.stringify({id:id, sheet:'Transaksi'}) });
            loadRiwayat();
        }
    }

    function toggleAll(src) { document.querySelectorAll('.row-check').forEach(c => c.checked = src.checked); }

    async function hapusTerpilih() {
        const checked = document.querySelectorAll('.row-check:checked');
        if(checked.length === 0) return alert("Pilih data!");
        if(confirm(`Hapus ${checked.length} data?`)) {
            for(let c of checked) { await fetch(SCRIPT_URL + "?action=deleteRow", { method: "POST", body: JSON.stringify({id:c.value, sheet:'Transaksi'}) }); }
            loadRiwayat();
        }
    }

    let myChart;
    async function loadKeuangan() {
        const res = await fetch(SCRIPT_URL + "?action=readKeuangan");
        const data = await res.json();
        let tm = 0, tk = 0, harian = {};
        data.forEach(r => {
            let tgl = r[0].split(' ')[0], m = parseInt(r[2]||0), k = parseInt(r[3]||0);
            tm += m; tk += k; harian[tgl] = (harian[tgl] || 0) + m - k;
        });
        document.getElementById('stat-m').innerText = tm.toLocaleString();
        document.getElementById('stat-k').innerText = tk.toLocaleString();
        document.getElementById('stat-s').innerText = (tm - tk).toLocaleString();
        const labels = Object.keys(harian).sort();
        if(myChart) myChart.destroy();
        myChart = new Chart(document.getElementById('chartHarian'), {
            type: 'line', data: { labels, datasets: [{label:'Saldo', data:labels.map(l=>harian[l]), borderColor:'#0d6efd', fill:true, backgroundColor:'rgba(13,110,253,0.1)'}] },
            options: { responsive:true, maintainAspectRatio:false }
        });
    }

    async function simpanKeu() {
        const d = {ket:document.getElementById('k-ket').value, masuk:parseInt(document.getElementById('k-mas').value||0), keluar:parseInt(document.getElementById('k-kel').value||0)};
        await fetch(SCRIPT_URL+"?action=insertKeuangan", {method:"POST", body:JSON.stringify(d)});
        alert("Kas Terupdate!"); loadKeuangan();
    }

    window.onload = function() { toggleLayanan(); loadRiwayat(); };
</script>
</body>
</html>
