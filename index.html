<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go#Chenk Laundry - Web App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --blue: #0d6efd; --white: #ffffff; }
        body { background-color: #f0f2f5; font-family: sans-serif; }
        .navbar { background: var(--blue); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; border-radius: 12px; }
        .btn-primary { background: var(--blue); border: none; border-radius: 8px; }
        .nota-box { border: 2px dashed #0d6efd; padding: 15px; background: white; border-radius: 8px; }
    </style>
</head>
<body>

<nav class="navbar mb-4"><div class="container"><b>Go#Chenk Laundry Aplikasi</b></div></nav>

<div class="container mb-5">
    <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-transaksi">Transaksi</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-keuangan" onclick="loadKeuangan()">Keuangan</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-transaksi">
            <div class="row g-4">
                <div class="col-md-7">
                    <div class="card shadow-sm p-4">
                        <h5>Input Order</h5>
                        <form id="formL">
                            <input type="text" id="nama" class="form-control mb-3" placeholder="Nama Pelanggan" required oninput="updateNota()">
                            <select id="jenis" class="form-select mb-3" onchange="toggleJenis(); updateNota()">
                                <option value="Kiloan">Jasa Kiloan</option>
                                <option value="Satuan">Jasa Satuan</option>
                            </select>
                            <div id="box-kiloan">
                                <select id="jasa" class="form-select mb-3" onchange="updateNota()">
                                    <option value="Cuci Setrika">Cuci Setrika</option>
                                    <option value="Cuci Lipat">Cuci Lipat / Setrika Saja</option>
                                </select>
                                <label>Durasi & Berat (Min 2kg)</label>
                                <div class="input-group mb-3">
                                    <select id="durasi" class="form-select" onchange="updateNota()">
                                        <option value="1">1 Hari</option><option value="2">2 Hari</option>
                                        <option value="3">3 Hari</option><option value="4">4 Hari</option>
                                    </select>
                                    <input type="number" id="berat" class="form-control" value="2" min="2" oninput="updateNota()">
                                    <span class="input-group-text">Kg</span>
                                </div>
                            </div>
                            <div id="box-satuan" style="display:none">
                                <input type="text" id="item" class="form-control mb-3" placeholder="Nama Barang (Karpet/Tas/dll)">
                                <input type="number" id="hargaS" class="form-control mb-3" placeholder="Harga Total (Rp)" oninput="updateNota()">
                            </div>
                            <input type="number" id="dp" class="form-control mb-3" placeholder="Uang Muka / DP (Kosongkan jika 0)" oninput="updateNota()">
                            <button type="button" onclick="kirimData()" id="btnSimpan" class="btn btn-primary w-100">Simpan Transaksi</button>
                        </form>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="nota-box shadow-sm">
                        <h6 class="text-center">PREVIEW NOTA</h6><hr>
                        <div id="prev-content">
                            <p>Nama: <span id="n1">-</span></p>
                            <p>Layanan: <span id="l1">-</span></p>
                            <p>Total: <b>Rp <span id="t1">0</span></b></p>
                            <p>Sisa: <span id="s1">0</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4 shadow-sm p-3 table-responsive">
                <h6>Riwayat Transaksi</h6>
                <table class="table table-sm align-middle" id="tabelR">
                    <thead><tr><th>ID</th><th>Nama</th><th>Total</th><th>Bayar</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-keuangan">
            <div class="card p-3 shadow-sm mb-4">
                <canvas id="chartK" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // GANTI URL DI BAWAH INI DENGAN URL GOOGLE APPS SCRIPT ANDA
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxS4HKu5PMq3GgZE7w-zkiHUtw4KG6LMTA3XGRhNLxYYxvFgo5_EKHzkO34NESKfWMl/exec";

    function toggleJenis() {
        const j = document.getElementById('jenis').value;
        document.getElementById('box-kiloan').style.display = j === 'Kiloan' ? 'block' : 'none';
        document.getElementById('box-satuan').style.display = j === 'Satuan' ? 'block' : 'none';
    }

    function updateNota() {
        const jenis = document.getElementById('jenis').value;
        let total = 0;
        let info = "";

        if(jenis === 'Kiloan') {
            const jasa = document.getElementById('jasa').value;
            const durasi = parseInt(document.getElementById('durasi').value);
            const berat = Math.max(2, parseFloat(document.getElementById('berat').value || 0));
            let hg = 0;
            if(jasa === 'Cuci Setrika') hg = [0, 10000, 7000, 6000, 5000][durasi];
            else hg = [0, 7000, 5000, 4000, 4000][durasi];
            total = hg * berat;
            info = jasa + " " + durasi + " Hari";
        } else {
            total = parseInt(document.getElementById('hargaS').value || 0);
            info = document.getElementById('item').value || "Satuan";
        }

        const dp = parseInt(document.getElementById('dp').value || 0);
        document.getElementById('n1').innerText = document.getElementById('nama').value || "-";
        document.getElementById('l1').innerText = info;
        document.getElementById('t1').innerText = total.toLocaleString();
        document.getElementById('s1').innerText = (total - dp).toLocaleString();
        return {total, info};
    }

    async function kirimData() {
        const btn = document.getElementById('btnSimpan');
        btn.disabled = true; btn.innerText = "Proses...";
        const n = updateNota();
        const data = {
            nama: document.getElementById('nama').value,
            jenis: document.getElementById('jenis').value,
            layanan: n.info,
            durasi: document.getElementById('durasi').value,
            berat: document.getElementById('berat').value,
            total: n.total,
            dp: document.getElementById('dp').value || 0
        };

        await fetch(SCRIPT_URL + "?action=insert", {
            method: "POST",
            body: JSON.stringify(data)
        });
        
        alert("Transaksi Berhasil!");
        document.getElementById('formL').reset();
        btn.disabled = false; btn.innerText = "Simpan Transaksi";
        loadRiwayat();
    }

    async function loadRiwayat() {
        const res = await fetch(SCRIPT_URL + "?action=read");
        const data = await res.json();
        const tbody = document.querySelector('#tabelR tbody');
        tbody.innerHTML = data.map(r => `
            <tr>
                <td>${r[0]}</td><td>${r[2]}</td><td>${parseInt(r[7]).toLocaleString()}</td>
                <td><span class="badge ${r[9]=='Lunas'?'bg-success':'bg-warning'}">${r[9]}</span></td>
                <td><span class="badge bg-info">${r[10]}</span></td>
            </tr>
        `).join('');
    }

    // Load Data Awal
    window.onload = loadRiwayat;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
